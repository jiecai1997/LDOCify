---
title: "spotify-test"
author: "Jie Cai"
date: "4/5/2018"
output: html_document
---

```{r setup, include=FALSE}
library(jsonlite)
library(glue)
library(magrittr)
library(stringr)

MUSIXMATCH_API_KEY = 'e548b2085bdc0899babb6bf079158faa'

get_lyrics = function(spotify_track) {
  artist_name = spotify_track$artist_name
  track_name =  spotify_track$track_name
  album_name = spotify_track$album_name
  url = glue('http://api.musixmatch.com/ws/1.1/track.search?q_artist={artist_name}&q_track={track_name}&s_track_rating=desc&apikey={MUSIXMATCH_API_KEY}')
  
  print(url)
  
  response = read_json(URLencode(url))
  
  # API error
  if (response$message$header$status_code != 200) {
    stop(
      glue("Got {response$message$header$status_code} instead of 200 for track lookup")
    )
  }
  
  # No song was found
  if (length(response$message$body$track_list) == 0) {
    stop("Couldn't find tracks!")
  }
  
  track_id = response$message$body$track_list[[1]]$track$track_id
  lyrics_url = glue('http://api.musixmatch.com/ws/1.1/track.lyrics.get?track_id={track_id}&apikey={MUSIXMATCH_API_KEY}')
  
  lyrics_response = read_json(URLencode(lyrics_url))
  
  # API error
  if (lyrics_response$message$header$status_code != 200) {
    glue("Got {lyrics_response$message$header$status_code} instead of 200 for lyrics lookup")
  }
  lyrics_response$message$body$lyrics$lyrics_body
}

clean_lyrics = function(lyrics) {
  words = lyrics %>%
    tolower() %>%
    str_replace('this lyrics is not for commercial use', '') %>%
    str_replace_all('[\\s]+', ' ') %>%
    str_replace_all('[^a-z ]', '') %>%
    str_replace_all('[\\s]+', ' ') %>%
    trimws() %>%
    str_split(' ')
  
  # Words ends up being a list of length 1, so we unwrap it here
  words[[1]]
}

score_lyrics = function(words) {
  length(unique(words)) / length(words)
}

score_tracks = function(tracks) {
  scores = c()
  for (row in 1:nrow(tracks)) {
    track = tracks[row,]
    tryCatch({
      scores = c(
        scores, get_lyrics(track) %>% clean_lyrics() %>% score_lyrics()
      )
    }, error = function() {
      scores = c(scores, NA)
    })
  }
  scores
}

goldlink_top = read.csv('goldlink_top5.csv')
score_tracks(goldlink_top)
```
